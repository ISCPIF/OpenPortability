# =============================================================================
# Docker Compose - DEVELOPMENT OVERRIDE
# =============================================================================
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Ou build + run:
#   docker buildx bake && docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# =============================================================================
services:
  app:
    image: app:dev
    build:
      context: .
      dockerfile: Dockerfile.dev
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      - NODE_ENV=development
      - NEXT_CONFIG_FILE=./next.config.dev.js
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - NEXT_WEBPACK_USEPOLLING=1
    # Volumes pour hot-reload en dev
    volumes:
      - ./:/app:delegated
      - node_modules:/app/node_modules
      - next_cache:/app/.next
      - shared-tmp:/app/tmp
      - app_logs:/app/logs
    command: npm run dev
    stdin_open: true
    tty: true

  worker:
    image: worker:dev
    build:
      context: ./worker
      dockerfile: Dockerfile.dev
    user: "${UID:-1000}:${GID:-1000}"
    env_file:
      - ./worker/.env
    environment:
      - NODE_ENV=development
    networks:
      - default
      - db_openportability_db_network
    # Volumes pour hot-reload en dev
    volumes:
      - ./worker:/app
      - worker_node_modules:/app/node_modules
      - shared-tmp:/app/tmp
      - app_logs:/app/logs
    command: npm run dev

# Volumes nommés pour éviter les problèmes de permissions
volumes:
  node_modules:
  next_cache:
  worker_node_modules:

# Networks
networks:
  db_openportability_db_network:
    external: true